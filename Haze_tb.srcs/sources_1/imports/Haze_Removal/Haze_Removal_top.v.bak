`timescale 1ns/1ns
module Haze_Removal_top #(
	parameter	[10:0]	IMG_HDISP = 11'd1280, 
	parameter	[10:0]	IMG_VDISP = 11'd720  
)      
(
	input				clk             ,  				 
	input				rst_n           ,				 

	input				per_frame_vsync ,	 //å»é›¾å‰çš„å›¾åƒ
	input				per_frame_href  ,		 
	input				per_frame_clken ,	 
	input		[7:0]	per_img_red     ,		 
	input		[7:0]	per_img_green   ,		 
	input		[7:0]	per_img_blue    ,		 

	output				post_frame_vsync,	 //å»é›¾åçš„å›¾åƒ
	output				post_frame_href ,	 
	output				post_frame_clken,	 		 
	output		[7:0]	post_img_red    ,	
	output		[7:0]	post_img_green  ,	
	output		[7:0]	post_img_blue	,
    
    input               haze_removal_en     //å»é›¾ç®—æ³•ä½¿èƒ½
); 


//----------------------------------------------------------------------------
//VIP ç®—æ³•â€”â?”è®¡ç®—å½©è‰²å›¾åƒçš„æš—é?šé“ï¼Œå…±æ¶ˆè??5ä¸ªæ—¶é’Ÿå‘¨æœ?

wire 		post0_frame_vsync   ;   
wire 		post0_frame_href    ;   
wire 		post0_frame_clken   ;    
wire [7:0]	post0_img_dark      ;   //æš—é?šé“å›¾åƒ

wire [7:0]	post0_img_red       ;   //ä¸æš—é€šé“å›¾åƒåŒæ­¥çš„åŸå§‹å½©è‰²å›¾åƒ?
wire [7:0]	post0_img_green     ;	 
wire [7:0]	post0_img_blue      ;

VIP_Dark_Channel	u_VIP_Dark_Channel (
	.clk				(clk                ),					
	.rst_n				(rst_n              ),				

	.per_frame_vsync	(per_frame_vsync    ),		
	.per_frame_href		(per_frame_href     ),		
	.per_frame_clken	(per_frame_clken    ),		
	.per_img_red		(per_img_red        ),			
	.per_img_green		(per_img_green      ),		
	.per_img_blue		(per_img_blue       ),			
	
	.post_frame_vsync	(post0_frame_vsync  ),	
	.post_frame_href	(post0_frame_href   ),		
	.post_frame_clken	(post0_frame_clken  ),			
	.post_img_dark		(post0_img_dark     ),		//æš—é?šé“å›¾åƒ
    
	.post_img_red  	    (post0_img_red      ),		 
	.post_img_green	    (post0_img_green    ),		 
	.post_img_blue 	    (post0_img_blue     )
);

//----------------------------------------------------------------------------
//è®¡ç®—å¤§æ°”å…‰å¼ºåº?

wire [ 7:0] atmospheric_light;  //å¤§æ°”å…‰å¼ºåº?

VIP_Atmospheric_Light #(
	.IMG_HDISP          (IMG_HDISP          ), 
	.IMG_VDISP          (IMG_VDISP          ) 
)
u_VIP_Atmospheric_Light(
	.clk				(clk                ),					
	.rst_n				(rst_n              ),	

	.per_frame_vsync	(post0_frame_vsync  ),		
	.per_frame_href		(post0_frame_href   ),		
	.per_frame_clken	(post0_frame_clken  ),	
    .per_img_dark       (post0_img_dark     ),  //æš—é?šé“å›¾åƒ
    
	.per_img_red		(post0_img_red      ),	//å½©è‰²å›¾åƒ		
	.per_img_green		(post0_img_green    ),		
	.per_img_blue		(post0_img_blue     ),	

    .atmospheric_light  (atmospheric_light  ),  //å¤§æ°”å…‰å¼ºåº?
    .atmospheric_pos_x  (                   ),
    .atmospheric_pos_y  (                   ) 
);

//----------------------------------------------------------------------------
//è®¡ç®—é€å°„ç‡å›¾ï¼Œæ¶ˆè€?26ä¸ªæ—¶é’Ÿå‘¨æœ?

wire 		post1_frame_vsync ;   
wire 		post1_frame_href  ;   
wire 		post1_frame_clken ;    
wire [7:0]	post1_transmission; //é€å°„ç?

VIP_Transmission_Map u_VIP_Transmission_Map(
	.clk				(clk                ),					
	.rst_n				(rst_n              ),
    
	.per_frame_vsync	(post0_frame_vsync  ),		
	.per_frame_href		(post0_frame_href   ),		
	.per_frame_clken	(post0_frame_clken  ),	
    .per_img_dark       (post0_img_dark     ),  //æš—é?šé“å›¾åƒ

    .atmospheric_light  (atmospheric_light  ),  //å¤§æ°”å…‰å¼ºåº?

	.post_frame_vsync	(per_guide_vs  ),	
	.post_frame_href	(  ),		
	.post_frame_clken	(per_guide_hs  ),			
	.post_transmission	(per_guide_data )   //é€å°„ç?	
);
wire        per_guide_hs;
wire        per_guide_vs;
wire [7:0]  per_guide_data;
wire        post_guide_hs;
wire        post_guide_vs;
wire [7:0]  post_guide_data;

guide_filter#(
    .IMG_HDISP(IMG_HDISP),
    .IMG_VDISP(IMG_VDISP)
)guide_filter(
        .i_clk          (clk),
        .i_rst          (!rst_n),
        .per_img_href   (per_guide_hs),
        .per_img_vsync  (!per_guide_vs),
        .per_img_B      (per_guide_data),
        
        .post_img_B     (post_guide_data),
        .post_img_href  (post_guide_hs),
        .post_img_vsync (post_guide_vs)

);
assign post1_frame_vsync    =!post_guide_vs;
assign post1_frame_href     =post_guide_hs;
assign post1_frame_clken    =post_guide_hs;
assign post1_transmission   =post_guide_data;

//--------------------------------------
//å°†å½©è‰²å›¾åƒå»¶è¿?26ä¸ªæ—¶é’Ÿï¼Œä¸é?å°„ç‡å›¾åƒåŒæ­?

wire [23:0] dly26_img_rgb;

dmk_shift_regs #(
    .DWIDTH         (24     ) ,  //ä½å®½
    .DELAY_DUTY     (26+52     )    //å»¶è¿Ÿæ—¶é’Ÿå‘¨æœŸ
    )
u_delay_26clk(
    .clk            (clk    ),
    .rst_n          (rst_n  ),

    .idata          ({post0_img_red,post0_img_green,post0_img_blue}),
    .odata          (dly26_img_rgb  )
);

//----------------------------------------------------------------------------
//æ ¹æ®é€å°„ç‡å›¾åƒï¼Œä»æœ‰é›¾å›¾åƒä¸­æ¢å¤åœºæ™¯è¾å°„ï¼Œæ¶ˆè€?27ä¸ªæ—¶é’Ÿå‘¨æœ?

wire 		post2_frame_vsync;   
wire 		post2_frame_href ;   
wire 		post2_frame_clken;    
wire [7:0]	post2_img_red	 ;  
wire [7:0]	post2_img_green  ;  
wire [7:0]	post2_img_blue	 ;  

VIP_scene_radiance	u_VIP_scene_radiance
(
	.clk				(clk                    ),					
	.rst_n				(rst_n                  ),				
    
	.per_frame_vsync	(post1_frame_vsync      ),		
	.per_frame_href		(post1_frame_href       ),		
	.per_frame_clken	(post1_frame_clken      ),
        
	.per_transmission	(post1_transmission     ),      //é€å°„ç?
    
	.per_img_red		(dly26_img_rgb[23:16]   ),		//æœ‰é›¾å›¾åƒ	
	.per_img_green		(dly26_img_rgb[15: 8]   ),		
	.per_img_blue		(dly26_img_rgb[ 7: 0]   ),			

    .atmospheric_light  (atmospheric_light      ),      //å¤§æ°”å…‰å¼ºåº?
        
	.post_frame_vsync	(post2_frame_vsync      ),	
	.post_frame_href	(post2_frame_href       ),		
	.post_frame_clken	(post2_frame_clken      ),			
	.post_img_red		(post2_img_red	        ),		//æ— é›¾å›¾åƒ	
	.post_img_green		(post2_img_green        ),			
	.post_img_blue		(post2_img_blue	        )			
);

//----------------------------------------------------------------------------
//VIP ç®—æ³•â€”â?”Gammaæ ¡æ­£ï¼Œæå‡å»é›¾å›¾åƒäº®åº¦ï¼Œæ¶ˆè??1ä¸ªæ—¶é’Ÿå‘¨æœ?

wire 			post3_frame_vsync   ;   
wire 			post3_frame_href    ;   
wire 			post3_frame_clken   ;    
wire [7:0]		post3_img_red	    ;   
wire [7:0]		post3_img_green     ;   
wire [7:0]		post3_img_blue	    ;   

Curve_Gamma_1div_1P3 R_Gamma_1div_1P3(
	.clk				(clk                ),  			  
	.rst_n				(rst_n              ),	

	.per_frame_vsync	(post2_frame_vsync  ),	  
	.per_frame_href		(post2_frame_href   ),	  
	.per_frame_clken	(post2_frame_clken  ),	  
	.per_img_gray		(post2_img_red	    ),		  	  

	.post_frame_vsync	(post3_frame_vsync  ),
	.post_frame_href	(post3_frame_href   ),	
	.post_frame_clken	(post3_frame_clken  ),
	.post_img_gray		(post3_img_red      )	
);

Curve_Gamma_1div_1P3 G_Gamma_1div_1P3(
	.clk				(clk                ),  			  
	.rst_n				(rst_n              ),	

	.per_frame_vsync	(post2_frame_vsync  ),	  
	.per_frame_href		(post2_frame_href   ),	  
	.per_frame_clken	(post2_frame_clken  ),	  
	.per_img_gray		(post2_img_green    ),		  	  

	.post_img_gray		(post3_img_green    )	
);

Curve_Gamma_1div_1P3 B_Gamma_1div_1P3(
	.clk				(clk                ),  			  
	.rst_n				(rst_n              ),	

	.per_frame_vsync	(post2_frame_vsync  ),	  
	.per_frame_href		(post2_frame_href   ),	  
	.per_frame_clken	(post2_frame_clken  ),	  
	.per_img_gray		(post2_img_blue	    ),		  	  

	.post_img_gray		(post3_img_blue     )	
);

//--------------------------------------
//å°†å½©è‰²å›¾åƒå»¶è¿?28ä¸ªæ—¶é’Ÿï¼Œä¸Gammaæ ¡æ­£åçš„å›¾åƒåŒæ­¥

wire [23:0] dly28_img_rgb;

dmk_shift_regs #(
    .DWIDTH         (24             ) ,  //ä½å®½
    .DELAY_DUTY     (26             )    //å»¶è¿Ÿæ—¶é’Ÿå‘¨æœŸ
    )       
u_delay_28clk(      
    .clk            (clk            ),
    .rst_n          (rst_n          ),

    .idata          (dly26_img_rgb  ),
    .odata          (dly28_img_rgb  )
);



assign post_img_red     = haze_removal_en ? post3_img_red   : dly28_img_rgb[23:16];
assign post_img_green   = haze_removal_en ? post3_img_green : dly28_img_rgb[15: 8];
assign post_img_blue    = haze_removal_en ? post3_img_blue  : dly28_img_rgb[ 7: 0];

assign post_frame_vsync = post3_frame_vsync   ;	 
assign post_frame_href  = post3_frame_href    ;	 
assign post_frame_clken = post3_frame_clken   ;	 		 

endmodule
